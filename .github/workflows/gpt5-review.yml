name: GPT-5 Mini Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          # GitHub Actions outputì— ì €ì¥ (multiline ì§€ì›)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: GPT-5 Mini Code Review
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const https = require('https');
            const http = require('http');

            // Diff í¬ê¸° ì œí•œ (100KB)
            const diff = `${{ steps.diff.outputs.diff }}`;
            if (diff.length > 100000) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âš ï¸ PR í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤ (>100KB). GPT-5 ë¦¬ë·°ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.'
              });
              return;
            }

            const reviewPrompt = `# ValueIn Academy í”„ë¡œì íŠ¸ ì½”ë“œ ë¦¬ë·°

## í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸
- **Stack**: Next.js 15 App Router, Supabase (PostgreSQL + Auth + RLS), TypeScript strict mode
- **Domain**: í•™ì› ê´€ë¦¬ ì‹œìŠ¤í…œ (í•™ìƒ/í•™ë¶€ëª¨/êµì§ì›)
- **Key Files**:
  - \`app/(dashboard)/\`: ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
  - \`app/(portal)/\`: í•™ë¶€ëª¨/í•™ìƒ í¬í„¸
  - \`lib/supabase/\`: Supabase í´ë¼ì´ì–¸íŠ¸
  - \`database/\`: RLS ì •ì±… ë° ë§ˆì´ê·¸ë ˆì´ì…˜

## ë¦¬ë·° ì¤‘ì  ì‚¬í•­
1. **Supabase RLS ì •ì±…**:
   - í•™ìƒ/í•™ë¶€ëª¨ëŠ” ë³¸ì¸ ë°ì´í„°ë§Œ ì ‘ê·¼ (student_id, parent_id í•„í„°)
   - êµì§ì›ì€ ì „ì²´ ì ‘ê·¼ (auth_id, status='ì¬ì§' í™•ì¸)
   - CREATE TABLE ì‹œ ë°˜ë“œì‹œ RLS ENABLE ë° ì •ì±… ì¶”ê°€

2. **Next.js 15 í˜¸í™˜ì„±**:
   - Server Actions: async cookies() ì‚¬ìš©
   - Client Components: 'use client' ì§€ì‹œì–´
   - Server Components: getUser() ì‚¬ìš© (not getSession())

3. **TypeScript íƒ€ì… ì•ˆì „ì„±**:
   - Supabase íƒ€ì… ì¼ì¹˜ (\`types/supabase.ts\`)
   - Nullable í•„ë“œ ì•ˆì „ ì²˜ë¦¬ (\`|| false\`, \`|| ''\`)

4. **ë³´ì•ˆ ì·¨ì•½ì **:
   - SQL injection ìœ„í—˜ (raw query ì‚¬ìš© ê¸ˆì§€)
   - XSS (ì‚¬ìš©ì ì…ë ¥ sanitization)
   - CSRF (Server Actions ì‚¬ìš©)
   - Rate limiting (SMS/Email API)

5. **ì„±ëŠ¥ ìµœì í™”**:
   - N+1 ì¿¼ë¦¬ ë°©ì§€ (JOIN ì‚¬ìš©)
   - ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ (React.memo, useMemo)
   - í° ë²ˆë“¤ ì‚¬ì´ì¦ˆ (dynamic import)

## ì½”ë“œ ë³€ê²½ ë‚´ìš©
\`\`\`diff
${diff}
\`\`\`

## ìš”ì²­ì‚¬í•­
ê° íŒŒì¼ë³„ë¡œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë¦¬ë·°í•´ì£¼ì„¸ìš”:

### ğŸ“ [íŒŒì¼ê²½ë¡œ]

**Priority**: Critical | High | Medium | Low

**Issue**: [ë¬¸ì œ ì„¤ëª…]

**Current Code** (Line XX-YY):
\`\`\`typescript
[í˜„ì¬ ì½”ë“œ]
\`\`\`

**Problem**: [ì™œ ë¬¸ì œì¸ì§€ ì„¤ëª…]

**Suggested Fix**:
\`\`\`typescript
[ìˆ˜ì • ì œì•ˆ ì½”ë“œ]
\`\`\`

---

## âœ… Summary
**Issues Found**: X
- ğŸ”´ Critical: X
- ğŸŸ¡ High: X
- ğŸŸ¢ Medium: X
- âšª Low: X

**Recommendation**: [ë¨¸ì§€ ê°€ëŠ¥ ì—¬ë¶€ ë° ì¡°ê±´]
`;

            // OpenAI API í˜¸ì¶œ (GPT-5 Mini)
            const data = JSON.stringify({
              model: 'gpt-4o-mini',  // GPT-5 Mini ëª¨ë¸
              messages: [
                {
                  role: 'system',
                  content: 'You are a senior code reviewer specializing in Next.js, Supabase, and TypeScript. Provide concise, actionable feedback with specific code examples.'
                },
                { role: 'user', content: reviewPrompt }
              ],
              temperature: 0.3,
              max_tokens: 4000
            });

            const options = {
              hostname: 'api.openai.com',
              path: '/v1/chat/completions',
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                'Content-Type': 'application/json',
                'Content-Length': data.length
              }
            };

            const apiCall = new Promise((resolve, reject) => {
              const req = https.request(options, (res) => {
                let body = '';
                res.on('data', (chunk) => { body += chunk; });
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(body));
                  } catch (e) {
                    reject(e);
                  }
                });
              });
              req.on('error', reject);
              req.write(data);
              req.end();
            });

            let result;
            try {
              result = await apiCall;
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ GPT-5 Mini API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`
              });
              return;
            }

            if (result.error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ OpenAI API Error: ${result.error.message}`
              });
              return;
            }

            const reviewComment = result.choices[0].message.content;

            // PRì— ë¦¬ë·° ì½”ë©˜íŠ¸ ì‘ì„±
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ¤– GPT-5 Mini Code Review\n\n${reviewComment}\n\n---\n*Powered by OpenAI GPT-4o-mini | Cost: ~$0.01 per review*`
            });

      - name: Check Review for Critical Issues
        uses: actions/github-script@v7
        with:
          script: |
            // Critical ì´ìŠˆ ë°œê²¬ ì‹œ PR ë¸”ë¡
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const latestReview = comments.data[comments.data.length - 1]?.body || '';

            if (latestReview.includes('**Priority: Critical**') ||
                latestReview.includes('Priority**: Critical')) {
              core.setFailed('ğŸ”´ Critical issues found by GPT-5 Mini. Please fix before merging.');
            }
