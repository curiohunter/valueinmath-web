name: GPT-5 Mini Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          # GitHub Actions output에 저장 (multiline 지원)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: GPT-5 Mini Code Review
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const https = require('https');

            // Diff 크기 제한 (100KB)
            const diff = String(`${{ steps.diff.outputs.diff }}`);
            if (diff.length > 100000) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '⚠️ PR 크기가 너무 큽니다 (>100KB). GPT-5 리뷰를 건너뜁니다.'
              });
              return;
            }

            const reviewPrompt = String.raw`# ValueIn Academy 프로젝트 코드 리뷰

            ## 프로젝트 컨텍스트
            - Stack: Next.js 15 App Router, Supabase (PostgreSQL + Auth + RLS), TypeScript strict mode
            - Domain: 학원 관리 시스템 (학생/학부모/교직원)

            ## 리뷰 중점 사항
            1. Supabase RLS 정책: 학생/학부모는 본인 데이터만, 교직원은 전체 접근
            2. Next.js 15 호환성: async cookies(), Server Actions
            3. TypeScript 타입 안전성: Nullable 필드 처리
            4. 보안 취약점: SQL injection, XSS, CSRF
            5. 성능 최적화: N+1 쿼리, 리렌더링, 번들 사이즈

            ## 코드 변경 내용
            ` + '```diff\n' + diff + '\n```' + String.raw`

            ## 요청사항
            각 파일별로 다음 형식으로 리뷰:
            - Priority: Critical/High/Medium/Low
            - Issue 설명
            - 현재 코드 (Line XX-YY)
            - Problem 설명
            - Suggested Fix

            ## Summary
            Issues Found와 Recommendation 제공`;

            // OpenAI API 호출 (GPT-5 Mini)
            const data = JSON.stringify({
              model: 'gpt-4o-mini',  // GPT-5 Mini 모델
              messages: [
                {
                  role: 'system',
                  content: 'You are a senior code reviewer specializing in Next.js, Supabase, and TypeScript. Provide concise, actionable feedback with specific code examples.'
                },
                { role: 'user', content: reviewPrompt }
              ],
              temperature: 0.3,
              max_tokens: 4000
            });

            const options = {
              hostname: 'api.openai.com',
              path: '/v1/chat/completions',
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                'Content-Type': 'application/json',
                'Content-Length': data.length
              }
            };

            const apiCall = new Promise((resolve, reject) => {
              const req = https.request(options, (res) => {
                let body = '';
                res.on('data', (chunk) => { body += chunk; });
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(body));
                  } catch (e) {
                    reject(e);
                  }
                });
              });
              req.on('error', reject);
              req.write(data);
              req.end();
            });

            let result;
            try {
              result = await apiCall;
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `❌ GPT-5 Mini API 호출 실패: ${error.message}`
              });
              return;
            }

            if (result.error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `❌ OpenAI API Error: ${result.error.message}`
              });
              return;
            }

            const reviewComment = result.choices[0].message.content;

            // PR에 리뷰 코멘트 작성
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## 🤖 GPT-5 Mini Code Review\n\n${reviewComment}\n\n---\n*Powered by OpenAI GPT-4o-mini | Cost: ~$0.01 per review*`
            });

      - name: Check Review for Critical Issues
        uses: actions/github-script@v7
        with:
          script: |
            // Critical 이슈 발견 시 PR 블록
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const latestReview = comments.data[comments.data.length - 1]?.body || '';

            if (latestReview.includes('**Priority: Critical**') ||
                latestReview.includes('Priority**: Critical')) {
              core.setFailed('🔴 Critical issues found by GPT-5 Mini. Please fix before merging.');
            }
