name: Database Migration Check

on:
  pull_request:
    paths:
      - 'database/**'
      - 'types/supabase.ts'

jobs:
  migration-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check RLS Policies
        run: |
          echo "🔍 Checking for missing RLS policies..."

          # database/migrations/ 폴더의 모든 SQL 파일 검사
          if [ -d "database/migrations" ]; then
            for file in database/migrations/*.sql; do
              if [ -f "$file" ]; then
                echo "Checking: $file"

                # CREATE TABLE이 있는지 확인
                if grep -q "CREATE TABLE" "$file"; then
                  # 테이블 이름 추출 (여러 테이블 지원)
                  grep "CREATE TABLE" "$file" | while read -r line; do
                    # IF NOT EXISTS 고려하여 테이블 이름 추출
                    table=$(echo "$line" | sed -n 's/.*CREATE TABLE[[:space:]]\+\(IF NOT EXISTS[[:space:]]\+\)\?\([a-zA-Z_][a-zA-Z0-9_]*\).*/\2/p')

                    if [ -n "$table" ]; then
                      echo "  Found table: $table"

                      # RLS ENABLE 확인
                      if ! grep -q "ALTER TABLE.*$table.*ENABLE ROW LEVEL SECURITY" "$file"; then
                        echo "  ⚠️  WARNING: Table '$table' missing RLS ENABLE in $file"
                        echo "::warning file=$file::Table $table is missing 'ALTER TABLE $table ENABLE ROW LEVEL SECURITY'"
                      fi

                      # RLS 정책 존재 확인
                      if ! grep -q "CREATE POLICY.*ON.*$table" "$file"; then
                        echo "  ⚠️  WARNING: Table '$table' missing RLS policies in $file"
                        echo "::warning file=$file::Table $table has no CREATE POLICY statements"
                      fi
                    fi
                  done
                fi
              fi
            done
          else
            echo "No database/migrations/ directory found"
          fi

          echo "✅ RLS policy check completed"

      - name: Validate SQL Syntax
        run: |
          echo "🔍 Validating SQL syntax..."

          if [ -d "database/migrations" ]; then
            for file in database/migrations/*.sql; do
              if [ -f "$file" ]; then
                echo "Checking syntax: $file"

                # 기본 SQL 문법 검증 (간단한 패턴 매칭)
                # 1. 세미콜론 누락 확인
                if ! grep -q ";" "$file"; then
                  echo "::error file=$file::Missing semicolon - SQL statements should end with ;"
                  exit 1
                fi

                # 2. 주석 문법 확인 (-- 또는 /* */)
                if grep -qE "^[^-]*//.*$" "$file"; then
                  echo "::error file=$file::Invalid comment syntax - use -- or /* */ for SQL comments"
                  exit 1
                fi

                # 3. CASCADE 사용 시 경고
                if grep -qi "DROP.*CASCADE" "$file"; then
                  echo "::warning file=$file::CASCADE deletion detected - ensure this is intentional"
                fi
              fi
            done
          fi

          echo "✅ SQL syntax validation completed"
