name: Database Migration Check

on:
  pull_request:
    paths:
      - 'database/**'
      - 'types/supabase.ts'

jobs:
  migration-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check RLS Policies
        run: |
          echo "ğŸ” Checking for missing RLS policies..."

          # database/migrations/ í´ë”ì˜ ëª¨ë“  SQL íŒŒì¼ ê²€ì‚¬
          if [ -d "database/migrations" ]; then
            for file in database/migrations/*.sql; do
              if [ -f "$file" ]; then
                echo "Checking: $file"

                # CREATE TABLEì´ ìˆëŠ”ì§€ í™•ì¸
                if grep -q "CREATE TABLE" "$file"; then
                  # í…Œì´ë¸” ì´ë¦„ ì¶”ì¶œ (ì—¬ëŸ¬ í…Œì´ë¸” ì§€ì›)
                  grep "CREATE TABLE" "$file" | while read -r line; do
                    # IF NOT EXISTS ê³ ë ¤í•˜ì—¬ í…Œì´ë¸” ì´ë¦„ ì¶”ì¶œ
                    table=$(echo "$line" | sed -n 's/.*CREATE TABLE[[:space:]]\+\(IF NOT EXISTS[[:space:]]\+\)\?\([a-zA-Z_][a-zA-Z0-9_]*\).*/\2/p')

                    if [ -n "$table" ]; then
                      echo "  Found table: $table"

                      # RLS ENABLE í™•ì¸
                      if ! grep -q "ALTER TABLE.*$table.*ENABLE ROW LEVEL SECURITY" "$file"; then
                        echo "  âš ï¸  WARNING: Table '$table' missing RLS ENABLE in $file"
                        echo "::warning file=$file::Table $table is missing 'ALTER TABLE $table ENABLE ROW LEVEL SECURITY'"
                      fi

                      # RLS ì •ì±… ì¡´ì¬ í™•ì¸
                      if ! grep -q "CREATE POLICY.*ON.*$table" "$file"; then
                        echo "  âš ï¸  WARNING: Table '$table' missing RLS policies in $file"
                        echo "::warning file=$file::Table $table has no CREATE POLICY statements"
                      fi
                    fi
                  done
                fi
              fi
            done
          else
            echo "No database/migrations/ directory found"
          fi

          echo "âœ… RLS policy check completed"

      - name: Validate SQL Syntax
        run: |
          echo "ğŸ” Validating SQL syntax..."

          if [ -d "database/migrations" ]; then
            for file in database/migrations/*.sql; do
              if [ -f "$file" ]; then
                echo "Checking syntax: $file"

                # ê¸°ë³¸ SQL ë¬¸ë²• ê²€ì¦ (ê°„ë‹¨í•œ íŒ¨í„´ ë§¤ì¹­)
                # 1. ì„¸ë¯¸ì½œë¡  ëˆ„ë½ í™•ì¸
                if ! grep -q ";" "$file"; then
                  echo "::error file=$file::Missing semicolon - SQL statements should end with ;"
                  exit 1
                fi

                # 2. ì£¼ì„ ë¬¸ë²• í™•ì¸ (-- ë˜ëŠ” /* */)
                if grep -qE "^[^-]*//.*$" "$file"; then
                  echo "::error file=$file::Invalid comment syntax - use -- or /* */ for SQL comments"
                  exit 1
                fi

                # 3. CASCADE ì‚¬ìš© ì‹œ ê²½ê³ 
                if grep -qi "DROP.*CASCADE" "$file"; then
                  echo "::warning file=$file::CASCADE deletion detected - ensure this is intentional"
                fi
              fi
            done
          fi

          echo "âœ… SQL syntax validation completed"
