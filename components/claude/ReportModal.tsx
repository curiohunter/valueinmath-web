"use client"

import { useState, useRef } from "react"
import { 
  Dialog, 
  DialogContent, 
  DialogHeader, 
  DialogTitle,
  DialogDescription 
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Separator } from "@/components/ui/separator"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from "@/components/ui/alert-dialog"
import ReactMarkdown from 'react-markdown'
import { 
  Calendar,
  Star,
  Download,
  Printer,
  AlertTriangle,
  CheckCircle,
  Clock,
  Info,
  CalendarPlus,
  Edit3,
  Trash2,
  Save,
  X,
  Target
} from "lucide-react"
import { CLAUDE_ANALYSIS_TYPES, claudeUtils } from "@/types/claude"
import type { ClaudeInsightWithDetails, ClaudeRecommendation } from "@/types/claude"
import { toast } from "sonner"

interface ReportModalProps {
  insight: ClaudeInsightWithDetails
  open: boolean
  onOpenChange: (open: boolean) => void
  onInsightUpdate?: () => void
}

const getPriorityIcon = (priority: ClaudeRecommendation['priority']) => {
  switch (priority) {
    case 'highest':
      return <AlertTriangle className="h-4 w-4 text-red-800" />
    case 'high':
      return <AlertTriangle className="h-4 w-4 text-red-500" />
    case 'medium':
      return <Clock className="h-4 w-4 text-yellow-500" />
    case 'low':
      return <CheckCircle className="h-4 w-4 text-green-500" />
    case 'info':
      return <Info className="h-4 w-4 text-blue-500" />
    default:
      return <Info className="h-4 w-4 text-gray-500" />
  }
}

const getPriorityLabel = (priority: ClaudeRecommendation['priority']) => {
  switch (priority) {
    case 'highest': return 'ÏµúÏö∞ÏÑ†'
    case 'high': return 'ÎÜíÏùå'
    case 'medium': return 'Î≥¥ÌÜµ'
    case 'low': return 'ÎÇÆÏùå'
    case 'info': return 'Ï†ïÎ≥¥'
    default: return 'Ï†ïÎ≥¥'
  }
}

export function ReportModal({ insight, open, onOpenChange, onInsightUpdate }: ReportModalProps) {
  const [activeTab, setActiveTab] = useState("overview")
  const printRef = useRef<HTMLDivElement>(null)
  const [editingIndex, setEditingIndex] = useState<number | null>(null)
  const [editingRecommendation, setEditingRecommendation] = useState<ClaudeRecommendation | null>(null)
  const [isUpdating, setIsUpdating] = useState(false)
  
  const analysisTypeInfo = CLAUDE_ANALYSIS_TYPES[insight.analysis_type]
  const confidenceLabel = claudeUtils.getConfidenceLabel(insight.confidence_score || 0)
  const confidenceColor = claudeUtils.getConfidenceColor(insight.confidence_score || 0)

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('ko-KR', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  const formatDateRange = () => {
    if (!insight.data_period.start_date) {
      return insight.data_period.description || 'Í∏∞Í∞Ñ Ï†ïÎ≥¥ ÏóÜÏùå'
    }
    return claudeUtils.formatDateRange(insight.data_period)
  }

  const sortedRecommendations = [...(insight.recommendations || [])].sort((a, b) => {
    const priorityOrder = { highest: 0, high: 1, medium: 2, low: 3, info: 4 }
    return priorityOrder[a.priority] - priorityOrder[b.priority]
  })

  const handlePrint = () => {
    if (printRef.current) {
      const printWindow = window.open('', '_blank')
      if (printWindow) {
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <title>Claude Ïù∏ÏÇ¨Ïù¥Ìä∏ Î≥¥Í≥†ÏÑú</title>
              <meta charset="utf-8">
              <style>
                body {
                  font-family: 'Malgun Gothic', 'Noto Sans KR', sans-serif;
                  line-height: 1.6;
                  margin: 20px;
                  color: #333;
                }
                .report-header {
                  text-align: center;
                  margin-bottom: 20px;
                  border-bottom: 2px solid #3b82f6;
                  padding-bottom: 15px;
                }
                .report-title {
                  font-size: 24px;
                  font-weight: bold;
                  margin-bottom: 10px;
                  color: #1e40af;
                }
                .report-subtitle {
                  font-size: 16px;
                  color: #666;
                  margin-bottom: 5px;
                }
                .report-section {
                  margin-bottom: 20px;
                  padding: 15px;
                  border: 1px solid #e5e7eb;
                  border-radius: 8px;
                }
                .section-title {
                  font-size: 18px;
                  font-weight: bold;
                  margin-bottom: 15px;
                  color: #1f2937;
                }
                .recommendation {
                  margin-bottom: 15px;
                  padding: 10px;
                  border-left: 4px solid #3b82f6;
                  background-color: #f8fafc;
                }
                .priority-high { border-left-color: #dc2626; }
                .priority-medium { border-left-color: #ca8a04; }
                .priority-low { border-left-color: #059669; }
                .priority-info { border-left-color: #2563eb; }
                .metadata-grid {
                  display: grid;
                  grid-template-columns: 1fr;
                  gap: 10px;
                }
                .metadata-item {
                  padding: 8px 12px;
                  background-color: #f9fafb;
                  border-radius: 6px;
                  border: 1px solid #e5e7eb;
                }
                .metadata-item strong {
                  color: #374151;
                  display: inline-block;
                  min-width: 120px;
                }
                @media print {
                  body { margin: 15px; }
                  .report-section { 
                    page-break-inside: avoid; 
                    margin-bottom: 15px;
                  }
                  .report-header { margin-top: 0; }
                  .metadata-grid {
                    grid-template-columns: 1fr 1fr;
                    gap: 8px;
                  }
                  .metadata-item {
                    font-size: 14px;
                    padding: 6px 10px;
                  }
                }
              </style>
            </head>
            <body>
              ${printRef.current.innerHTML}
            </body>
          </html>
        `)
        printWindow.document.close()
        printWindow.focus()
        printWindow.print()
        printWindow.close()
      }
    }
  }

  const handleAddToCalendar = async (recommendation: ClaudeRecommendation) => {
    try {
      toast.info('ÏùºÏ†ïÏùÑ Îì±Î°ùÌïòÍ≥† ÏûàÏäµÎãàÎã§...')
      
      // Ï∫òÎ¶∞Îçî ÏùºÏ†ï Ï∂îÍ∞Ä API Ìò∏Ï∂ú
      const eventData = {
        title: `üìã ${recommendation.category}`,
        description: recommendation.action,
        start_time: recommendation.deadline ? new Date(recommendation.deadline).toISOString() : new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // ÎßàÍ∞êÏùº ÎòêÎäî ÏùºÏ£ºÏùº ÌõÑ
        end_time: recommendation.deadline ? new Date(new Date(recommendation.deadline).getTime() + 60 * 60 * 1000).toISOString() : new Date(Date.now() + 7 * 24 * 60 * 60 * 1000 + 60 * 60 * 1000).toISOString(), // 1ÏãúÍ∞Ñ ÌõÑ
        event_type: 'project'
      }

      const response = await fetch('/api/calendar/events', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(eventData)
      })

      if (response.ok) {
        const result = await response.json()
        toast.success(`‚úÖ ÏùºÏ†ïÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!\nüìÖ ${recommendation.category}`)
      } else {
        const errorData = await response.json()
        toast.error(`‚ùå ÏùºÏ†ï Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n${errorData.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'}`)
      }
    } catch (error) {
      console.error('ÏùºÏ†ï Îì±Î°ù Ï§ë Ïò§Î•ò:', error)
      toast.error(`‚ùå ÏùºÏ†ï Îì±Î°ù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n${error instanceof Error ? error.message : 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò'}`)
    }
  }

  // Ìé∏Ïßë ÏãúÏûë
  const handleEditStart = (index: number, recommendation: ClaudeRecommendation) => {
    setEditingIndex(index)
    setEditingRecommendation({ ...recommendation })
  }

  // Ìé∏Ïßë Ï∑®ÏÜå
  const handleEditCancel = () => {
    setEditingIndex(null)
    setEditingRecommendation(null)
  }

  // Ìé∏Ïßë Ï†ÄÏû•
  const handleEditSave = async () => {
    if (editingRecommendation === null || editingIndex === null) return

    setIsUpdating(true)
    try {
      toast.info('Ï∂îÏ≤úÏÇ¨Ìï≠ÏùÑ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎäî Ï§ë...')

      // ÏÉàÎ°úÏö¥ Ï∂îÏ≤úÏÇ¨Ìï≠ Î∞∞Ïó¥ ÏÉùÏÑ± (Í∏∞Ï°¥ required_resources ÌïÑÎìú Ïú†ÏßÄ)
      const updatedRecommendations = [...insight.recommendations]
      const originalRecommendation = insight.recommendations[editingIndex]
      updatedRecommendations[editingIndex] = {
        ...editingRecommendation,
        required_resources: originalRecommendation?.required_resources || []
      }

      const response = await fetch(`/api/claude-insights/${insight.id}/recommendations`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          recommendations: updatedRecommendations
        })
      })

      if (response.ok) {
        toast.success('‚úÖ Ï∂îÏ≤úÏÇ¨Ìï≠Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!')
        
        // Ìé∏Ïßë Î™®Îìú Ï¢ÖÎ£å
        setEditingIndex(null)
        setEditingRecommendation(null)
        
        // Î∂ÄÎ™® Ïª¥Ìè¨ÎÑåÌä∏ÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Îã§Ïãú Î°úÎìú
        if (onInsightUpdate) {
          onInsightUpdate()
        }
      } else {
        const errorData = await response.json()
        console.error('ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå® ÏÉÅÏÑ∏:', errorData)
        toast.error(`‚ùå ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${errorData.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'}`)
      }
    } catch (error) {
      console.error('Ï∂îÏ≤úÏÇ¨Ìï≠ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•ò:', error)
      toast.error(`‚ùå ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n${error instanceof Error ? error.message : 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò'}`)
    } finally {
      setIsUpdating(false)
    }
  }

  // Ï∂îÏ≤úÏÇ¨Ìï≠ ÏÇ≠Ï†ú
  const handleDelete = async (index: number) => {
    setIsUpdating(true)
    try {
      toast.info('Ï∂îÏ≤úÏÇ¨Ìï≠ÏùÑ ÏÇ≠Ï†úÌïòÎäî Ï§ë...')

      const response = await fetch(`/api/claude-insights/${insight.id}/recommendations?index=${index}`, {
        method: 'DELETE',
      })

      if (response.ok) {
        toast.success('‚úÖ Ï∂îÏ≤úÏÇ¨Ìï≠Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!')
        
        // Î∂ÄÎ™® Ïª¥Ìè¨ÎÑåÌä∏ÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Îã§Ïãú Î°úÎìú
        if (onInsightUpdate) {
          onInsightUpdate()
        }
      } else {
        const errorData = await response.json()
        toast.error(`‚ùå ÏÇ≠Ï†ú Ïã§Ìå®: ${errorData.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'}`)
      }
    } catch (error) {
      console.error('Ï∂îÏ≤úÏÇ¨Ìï≠ ÏÇ≠Ï†ú Ï§ë Ïò§Î•ò:', error)
      toast.error(`‚ùå ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n${error instanceof Error ? error.message : 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò'}`)
    } finally {
      setIsUpdating(false)
    }
  }

  // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ Ï≤òÎ¶¨
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (editingIndex !== null) {
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault()
        handleEditSave()
      } else if (e.key === 'Escape') {
        handleEditCancel()
      }
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent 
        className="max-w-4xl h-[85vh] overflow-hidden flex flex-col"
        onKeyDown={handleKeyDown}
      >
        {/* Ïù∏ÏáÑÏö© Ïª®ÌÖêÏ∏† (Ïà®Í≤®Ïßê) */}
        <div ref={printRef} style={{ display: 'none' }}>
          <div className="report-header">
            <div className="report-title">{insight.title}</div>
            <div className="report-subtitle">Î∂ÑÏÑù Ïú†Ìòï: {analysisTypeInfo.name}</div>
            <div className="report-subtitle">ÏÉùÏÑ±Ïùº: {insight.created_at ? formatDate(insight.created_at) : 'N/A'}</div>
            <div className="report-subtitle">Ïã†Î¢∞ÎèÑ: {Math.round((insight.confidence_score || 0) * 100)}%</div>
          </div>
          
          <div className="report-section">
            <div className="section-title">Î∂ÑÏÑù ÎÇ¥Ïö©</div>
            <div dangerouslySetInnerHTML={{
              __html: insight.content.replace(/\n/g, '<br>')
                .replace(/#{1,6}\s+/g, '')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
            }} />
          </div>
          
          {sortedRecommendations.length > 0 && (
            <div className="report-section">
              <div className="section-title">Ï∂îÏ≤úÏÇ¨Ìï≠</div>
              {sortedRecommendations.map((rec, index) => (
                <div key={index} className={`recommendation priority-${rec.priority}`}>
                  <strong>[{getPriorityLabel(rec.priority)}] {rec.category}:</strong><br/>
                  {rec.action}
                  {rec.deadline && <><br/><strong>ÎßàÍ∞êÏùº:</strong> {rec.deadline}</>}
                  {rec.estimated_impact && <><br/><strong>ÏòàÏÉÅ Ìö®Í≥º:</strong> {rec.estimated_impact}</>}
                </div>
              ))}
            </div>
          )}
          
          {/* ÏÉÅÏÑ∏Ï†ïÎ≥¥ (Î©îÌÉÄÎç∞Ïù¥ÌÑ∞) ÏÑπÏÖò */}
          <div className="report-section">
            <div className="section-title">ÏÉÅÏÑ∏Ï†ïÎ≥¥</div>
            <div className="metadata-grid">
              {insight.metadata?.data_source && (
                <div className="metadata-item">
                  <strong>Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:</strong> {insight.metadata.data_source}
                </div>
              )}
              {insight.metadata?.analysis_method && (
                <div className="metadata-item">
                  <strong>Î∂ÑÏÑù Î∞©Î≤ï:</strong> {insight.metadata.analysis_method}
                </div>
              )}
              {insight.metadata?.model_version && (
                <div className="metadata-item">
                  <strong>Î™®Îç∏ Î≤ÑÏ†Ñ:</strong> {insight.metadata.model_version}
                </div>
              )}
              {insight.metadata?.student_count && (
                <div className="metadata-item">
                  <strong>Î∂ÑÏÑù ÎåÄÏÉÅ ÌïôÏÉù Ïàò:</strong> {insight.metadata.student_count}Î™Ö
                </div>
              )}
              {insight.metadata?.data_quality_score && (
                <div className="metadata-item">
                  <strong>Îç∞Ïù¥ÌÑ∞ ÌíàÏßà Ï†êÏàò:</strong> {Math.round(insight.metadata.data_quality_score * 100)}%
                </div>
              )}
              {insight.metadata?.processing_time_ms && (
                <div className="metadata-item">
                  <strong>Ï≤òÎ¶¨ ÏãúÍ∞Ñ:</strong> {insight.metadata.processing_time_ms}ms
                </div>
              )}
              {insight.data_period && (
                <div className="metadata-item">
                  <strong>Î∂ÑÏÑù Í∏∞Í∞Ñ:</strong> {claudeUtils.formatDateRange(insight.data_period)}
                </div>
              )}
              {insight.tags && insight.tags.length > 0 && (
                <div className="metadata-item">
                  <strong>ÌÉúÍ∑∏:</strong> {insight.tags.join(', ')}
                </div>
              )}
            </div>
          </div>
        </div>
        <DialogHeader>
          <div className="flex items-start justify-between gap-4 pr-8">
            <div className="flex-1">
              <DialogTitle className="text-xl font-bold leading-tight">
                {insight.title}
              </DialogTitle>
              
              <div className="mt-2 space-y-2">
                <div className="flex items-center gap-2 flex-wrap">
                  <Badge 
                    variant="secondary"
                    style={{ 
                      backgroundColor: `${analysisTypeInfo.color}15`,
                      color: analysisTypeInfo.color,
                      border: `1px solid ${analysisTypeInfo.color}30`
                    }}
                  >
                    <span className="mr-1">{analysisTypeInfo.icon}</span>
                    {analysisTypeInfo.name}
                  </Badge>
                  
                  <Badge 
                    variant="outline"
                    style={{ 
                      color: confidenceColor,
                      borderColor: confidenceColor 
                    }}
                  >
                    <Star className="h-3 w-3 mr-1" />
                    Ïã†Î¢∞ÎèÑ {confidenceLabel}
                  </Badge>
                  
                  <Badge variant="outline" className="text-xs">
                    <Calendar className="h-3 w-3 mr-1" />
                    {insight.created_at ? formatDate(insight.created_at) : 'N/A'}
                  </Badge>
                </div>
                
                {insight.tags && insight.tags.length > 0 && (
                  <div className="flex flex-wrap gap-1">
                    {insight.tags.map((tag, index) => (
                      <Badge 
                        key={index} 
                        variant="secondary" 
                        className="text-xs"
                        style={{ 
                          backgroundColor: `${claudeUtils.getTagColor(tag)}15`,
                          color: claudeUtils.getTagColor(tag)
                        }}
                      >
                        {tag}
                      </Badge>
                    ))}
                  </div>
                )}
              </div>
            </div>
            
            <div className="flex gap-2">
              <Button variant="outline" size="sm" onClick={handlePrint}>
                <Printer className="h-4 w-4 mr-2" />
                Ïù∏ÏáÑ
              </Button>
            </div>
          </div>
        </DialogHeader>

        <Tabs value={activeTab} onValueChange={setActiveTab} className="flex-1 overflow-hidden flex flex-col">
          <div className="flex items-center justify-between mb-4">
            <TabsList className="grid grid-cols-3 shrink-0 w-auto">
              <TabsTrigger value="overview">Í∞úÏöî</TabsTrigger>
              <TabsTrigger value="recommendations">
                Ï∂îÏ≤úÏÇ¨Ìï≠ 
                {sortedRecommendations.length > 0 && (
                  <Badge variant="secondary" className="ml-1 h-4 text-xs">
                    {sortedRecommendations.length}
                  </Badge>
                )}
              </TabsTrigger>
              <TabsTrigger value="metadata">ÏÉÅÏÑ∏Ï†ïÎ≥¥</TabsTrigger>
            </TabsList>
          </div>

          <ScrollArea className="flex-1 h-0">
            <TabsContent value="overview" className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg">Î∂ÑÏÑù ÎÇ¥Ïö©</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="prose prose-sm max-w-none prose-headings:text-gray-900 prose-p:text-gray-700 prose-strong:text-gray-900 prose-li:text-gray-700">
                    <ReactMarkdown
                      components={{
                        h1: ({node, ...props}) => <h1 className="text-xl font-bold text-gray-900 mb-3" {...props} />,
                        h2: ({node, ...props}) => <h2 className="text-lg font-semibold text-gray-900 mb-2 mt-4" {...props} />,
                        h3: ({node, ...props}) => <h3 className="text-base font-medium text-gray-900 mb-2 mt-3" {...props} />,
                        p: ({node, ...props}) => <p className="text-sm text-gray-700 mb-2 leading-relaxed" {...props} />,
                        ul: ({node, ...props}) => <ul className="text-sm text-gray-700 mb-2 ml-4 list-disc" {...props} />,
                        ol: ({node, ...props}) => <ol className="text-sm text-gray-700 mb-2 ml-4 list-decimal" {...props} />,
                        li: ({node, ...props}) => <li className="mb-1" {...props} />,
                        strong: ({node, ...props}) => <strong className="font-semibold text-gray-900" {...props} />,
                        em: ({node, ...props}) => <em className="italic text-gray-800" {...props} />,
                        code: ({node, ...props}) => <code className="bg-gray-100 px-1 py-0.5 rounded text-xs font-mono" {...props} />,
                        blockquote: ({node, ...props}) => <blockquote className="border-l-4 border-blue-200 pl-4 italic text-gray-600" {...props} />,
                      }}
                    >
                      {insight.content}
                    </ReactMarkdown>
                  </div>
                </CardContent>
              </Card>

              {insight.data_period && (
                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg flex items-center gap-2">
                      <Calendar className="h-5 w-5" />
                      Î∂ÑÏÑù Í∏∞Í∞Ñ
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-2 text-sm">
                      <div><strong>Í∏∞Í∞Ñ:</strong> {formatDateRange()}</div>
                      {insight.data_period.scope && (
                        <div><strong>Î≤îÏúÑ:</strong> {insight.data_period.scope}</div>
                      )}
                      {insight.data_period.data_sources && insight.data_period.data_sources.length > 0 && (
                        <div>
                          <strong>Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:</strong> {insight.data_period.data_sources.join(', ')}
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>
              )}
            </TabsContent>

            <TabsContent value="recommendations" className="space-y-4">
              {sortedRecommendations.length === 0 ? (
                <Card>
                  <CardContent className="p-8 text-center">
                    <Target className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                    <h3 className="text-lg font-medium text-gray-900 mb-2">
                      Ï∂îÏ≤úÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§
                    </h3>
                    <p className="text-gray-600">
                      Ïù¥ Ïù∏ÏÇ¨Ïù¥Ìä∏Ïóê ÎåÄÌïú Ï∂îÏ≤úÏÇ¨Ìï≠Ïù¥ ÏïÑÏßÅ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.
                    </p>
                  </CardContent>
                </Card>
              ) : (
                <div className="space-y-4">
                  {sortedRecommendations.map((recommendation, index) => (
                    <Card key={index} className="border-l-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-950/20 dark:to-indigo-950/20" 
                          style={{ borderLeftColor: claudeUtils.getPriorityColor(recommendation.priority) }}>
                      <CardContent className="p-6">
                        {editingIndex === index ? (
                          // Ìé∏Ïßë Î™®Îìú
                          <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div>
                                <label className="text-sm font-medium text-gray-700 block mb-2">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                                <Input
                                  value={editingRecommendation?.category || ''}
                                  onChange={(e) => setEditingRecommendation(prev => 
                                    prev ? { ...prev, category: e.target.value } : null
                                  )}
                                  placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                />
                              </div>
                              <div>
                                <label className="text-sm font-medium text-gray-700 block mb-2">Ïö∞ÏÑ†ÏàúÏúÑ</label>
                                <Select
                                  value={editingRecommendation?.priority || 'info'}
                                  onValueChange={(value: 'highest' | 'high' | 'medium' | 'low' | 'info') => 
                                    setEditingRecommendation(prev => 
                                      prev ? { ...prev, priority: value } : null
                                    )
                                  }
                                >
                                  <SelectTrigger>
                                    <SelectValue />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="highest">ÏµúÏö∞ÏÑ†</SelectItem>
                                    <SelectItem value="high">ÎÜíÏùå</SelectItem>
                                    <SelectItem value="medium">Î≥¥ÌÜµ</SelectItem>
                                    <SelectItem value="low">ÎÇÆÏùå</SelectItem>
                                    <SelectItem value="info">Ï†ïÎ≥¥</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                            </div>
                            
                            <div>
                              <label className="text-sm font-medium text-gray-700 block mb-2">Ïï°ÏÖò</label>
                              <Textarea
                                value={editingRecommendation?.action || ''}
                                onChange={(e) => setEditingRecommendation(prev => 
                                  prev ? { ...prev, action: e.target.value } : null
                                )}
                                placeholder="Ï∂îÏ≤úÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                rows={3}
                              />
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div>
                                <label className="text-sm font-medium text-gray-700 block mb-2">ÎßàÍ∞êÏùº</label>
                                <Input
                                  type="date"
                                  value={editingRecommendation?.deadline || ''}
                                  onChange={(e) => setEditingRecommendation(prev => 
                                    prev ? { ...prev, deadline: e.target.value } : null
                                  )}
                                />
                              </div>
                              <div>
                                <label className="text-sm font-medium text-gray-700 block mb-2">ÏòàÏÉÅ Ìö®Í≥º</label>
                                <Input
                                  value={editingRecommendation?.estimated_impact || ''}
                                  onChange={(e) => setEditingRecommendation(prev => 
                                    prev ? { ...prev, estimated_impact: e.target.value } : null
                                  )}
                                  placeholder="ÏòàÏÉÅ Ìö®Í≥ºÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                />
                              </div>
                            </div>
                            
                            <div className="flex justify-end gap-2">
                              <Button
                                size="sm"
                                variant="outline"
                                onClick={handleEditCancel}
                                disabled={isUpdating}
                              >
                                <X className="h-4 w-4 mr-1" />
                                Ï∑®ÏÜå
                              </Button>
                              <Button
                                size="sm"
                                onClick={handleEditSave}
                                disabled={isUpdating}
                              >
                                <Save className="h-4 w-4 mr-1" />
                                {isUpdating ? 'Ï†ÄÏû• Ï§ë...' : 'Ï†ÄÏû•'}
                              </Button>
                            </div>
                          </div>
                        ) : (
                          // ÏùºÎ∞ò Î≥¥Í∏∞ Î™®Îìú
                          <div className="flex items-start justify-between gap-4">
                            <div className="flex items-start gap-3 flex-1">
                              {getPriorityIcon(recommendation.priority)}
                              <div className="flex-1 space-y-3">
                                <div className="flex items-center gap-2">
                                  <Badge 
                                    variant="secondary"
                                    style={{ 
                                      backgroundColor: `${claudeUtils.getPriorityColor(recommendation.priority)}20`,
                                      color: claudeUtils.getPriorityColor(recommendation.priority),
                                      border: `1px solid ${claudeUtils.getPriorityColor(recommendation.priority)}40`
                                    }}
                                  >
                                    {getPriorityLabel(recommendation.priority)}
                                  </Badge>
                                  <span className="text-sm font-semibold text-gray-800">
                                    {recommendation.category}
                                  </span>
                                </div>
                                
                                <p className="text-sm leading-relaxed text-gray-700 font-medium">
                                  {recommendation.action}
                                </p>
                                
                                <div className="space-y-2">
                                  {recommendation.deadline && (
                                    <div className="flex items-center gap-2 text-sm">
                                      <Clock className="h-4 w-4 text-orange-500" />
                                      <span className="font-medium text-gray-600">ÎßàÍ∞êÏùº:</span>
                                      <span className="text-orange-600 font-medium">{recommendation.deadline}</span>
                                    </div>
                                  )}
                                  {recommendation.estimated_impact && (
                                    <div className="flex items-center gap-2 text-sm">
                                      <CheckCircle className="h-4 w-4 text-green-500" />
                                      <span className="font-medium text-gray-600">ÏòàÏÉÅ Ìö®Í≥º:</span>
                                      <span className="text-green-600 font-medium">{recommendation.estimated_impact}</span>
                                    </div>
                                  )}
                                  {recommendation.required_resources && recommendation.required_resources.length > 0 && (
                                    <div className="flex items-center gap-2 text-sm">
                                      <Info className="h-4 w-4 text-blue-500" />
                                      <span className="font-medium text-gray-600">ÌïÑÏöî ÏûêÏõê:</span>
                                      <span className="text-blue-600 font-medium">{recommendation.required_resources.join(', ')}</span>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                            
                            <div className="flex flex-col gap-2 shrink-0">
                              <Button
                                size="sm"
                                variant="outline"
                                onClick={() => handleAddToCalendar(recommendation)}
                                className="bg-white hover:bg-blue-50 border-blue-200 text-blue-600 hover:text-blue-700"
                              >
                                <CalendarPlus className="h-4 w-4 mr-1" />
                                ÏùºÏ†ï Îì±Î°ù
                              </Button>
                              
                              <Button
                                size="sm"
                                variant="outline"
                                onClick={() => handleEditStart(index, recommendation)}
                                disabled={isUpdating}
                                className="bg-white hover:bg-green-50 border-green-200 text-green-600 hover:text-green-700"
                              >
                                <Edit3 className="h-4 w-4 mr-1" />
                                Ìé∏Ïßë
                              </Button>
                              
                              <AlertDialog>
                                <AlertDialogTrigger asChild>
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    disabled={isUpdating}
                                    className="bg-white hover:bg-red-50 border-red-200 text-red-600 hover:text-red-700"
                                  >
                                    <Trash2 className="h-4 w-4 mr-1" />
                                    ÏÇ≠Ï†ú
                                  </Button>
                                </AlertDialogTrigger>
                                <AlertDialogContent>
                                  <AlertDialogHeader>
                                    <AlertDialogTitle>Ï∂îÏ≤úÏÇ¨Ìï≠ ÏÇ≠Ï†ú</AlertDialogTitle>
                                    <AlertDialogDescription>
                                      Ïù¥ Ï∂îÏ≤úÏÇ¨Ìï≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.
                                    </AlertDialogDescription>
                                  </AlertDialogHeader>
                                  <AlertDialogFooter>
                                    <AlertDialogCancel>Ï∑®ÏÜå</AlertDialogCancel>
                                    <AlertDialogAction
                                      onClick={() => handleDelete(index)}
                                      className="bg-red-600 hover:bg-red-700"
                                    >
                                      ÏÇ≠Ï†ú
                                    </AlertDialogAction>
                                  </AlertDialogFooter>
                                </AlertDialogContent>
                              </AlertDialog>
                            </div>
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  ))}
                </div>
              )}
            </TabsContent>


            <TabsContent value="metadata" className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg">Î©îÌÉÄÎç∞Ïù¥ÌÑ∞</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                      <strong>Ïã†Î¢∞ÎèÑ Ï†êÏàò:</strong> {Math.round((insight.confidence_score || 0) * 100)}%
                    </div>
                    <div>
                      <strong>ÏÉÅÌÉú:</strong> {insight.status === 'active' ? 'ÌôúÏÑ±' : 'Î≥¥Í¥ÄÎê®'}
                    </div>
                    <div>
                      <strong>ÏÉùÏÑ±Ïùº:</strong> {insight.created_at ? formatDate(insight.created_at) : 'N/A'}
                    </div>
                    <div>
                      <strong>ÏµúÏ¢Ö ÏàòÏ†ï:</strong> {insight.updated_at ? formatDate(insight.updated_at) : 'N/A'}
                    </div>
                  </div>

                  {insight.metadata && Object.keys(insight.metadata).length > 0 && (
                    <>
                      <Separator />
                      <div>
                        <h4 className="font-medium mb-2">Ï∂îÍ∞Ä Ï†ïÎ≥¥</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                          {Object.entries(insight.metadata).map(([key, value]) => (
                            <div key={key}>
                              <strong>{key}:</strong> {String(value)}
                            </div>
                          ))}
                        </div>
                      </div>
                    </>
                  )}
                </CardContent>
              </Card>
            </TabsContent>
          </ScrollArea>
        </Tabs>
      </DialogContent>
    </Dialog>
  )
}