"use client"

import { useState } from "react"
import FullCalendar from "@fullcalendar/react"
import dayGridPlugin from "@fullcalendar/daygrid"
import interactionPlugin from "@fullcalendar/interaction"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import {
  StudyLogItem,
  TestLogItem,
  MakeupClassItem,
  ConsultationItem,
  MathflatRecordItem,
} from "@/types/portal"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"

interface LearningCalendarProps {
  study_logs: StudyLogItem[]
  test_logs: TestLogItem[]
  makeup_classes: MakeupClassItem[]
  consultations: ConsultationItem[]
  mathflat_records: MathflatRecordItem[]
}

interface EventDetailProps {
  type: "study" | "test" | "makeup" | "consultation" | "mathflat"
  data: StudyLogItem | TestLogItem | MakeupClassItem | ConsultationItem | MathflatRecordItem
}

const attendanceLabels: Record<number, string> = {
  5: "Ï∂úÏÑù",
  4: "ÏßÄÍ∞Å",
  3: "Ï°∞Ìá¥",
  2: "Î≥¥Í∞ï",
  1: "Í≤∞ÏÑù",
}

export function LearningCalendar({
  study_logs,
  test_logs,
  makeup_classes,
  consultations,
  mathflat_records,
}: LearningCalendarProps) {
  const [selectedEvent, setSelectedEvent] = useState<EventDetailProps | null>(null)

  // Convert data to FullCalendar events (calendar service ÏÉâÏÉÅ Ï∞∏Ï°∞)
  // ÏàúÏÑú: ÌïôÏäµÏùºÏßÄ(1) > ÌÖåÏä§Ìä∏(2) > Îß§Ïì∞ÌîåÎû´(3) > Î≥¥Í∞ï(4) > ÏÉÅÎã¥(5)
  const events = [
    // Study logs
    ...study_logs.map((log) => ({
      id: `study-${log.id}`,
      title: `üìö ${log.book1 || log.class_name || "ÌïôÏäµÏùºÏßÄ"}${log.attendance_status ? `(${attendanceLabels[log.attendance_status]})` : ""}`,
      date: log.date,
      backgroundColor: "#10b981", // emerald-500
      borderColor: "#10b981",
      order: 1,
      extendedProps: {
        type: "study",
        data: log,
      },
    })),
    // Test logs
    ...test_logs.map((log) => ({
      id: `test-${log.id}`,
      title: `üìù ${log.test || "ÌÖåÏä§Ìä∏"}${log.test_score !== null ? ` (${log.test_score}Ï†ê)` : ""}`,
      date: log.date,
      backgroundColor: "#3b82f6", // blue-500
      borderColor: "#3b82f6",
      order: 2,
      extendedProps: {
        type: "test",
        data: log,
      },
    })),
    // Mathflat records
    ...mathflat_records.map((record) => ({
      id: `mathflat-${record.id}`,
      title: `üìä ${record.book_title || "Îß§Ïì∞ÌîåÎû´"} (${record.problem_solved || 0}Î¨∏Ï†ú, ${record.correct_rate?.toFixed(0) || 0}%)`,
      date: record.event_date || "",
      backgroundColor: "#f59e0b", // amber-500 (Í≤∞ÏÑù ÏÉâ)
      borderColor: "#f59e0b",
      order: 3,
      extendedProps: {
        type: "mathflat",
        data: record,
      },
    })),
    // Makeup classes
    ...makeup_classes.map((cls) => ({
      id: `makeup-${cls.id}`,
      title: `üîÑ ${cls.makeup_type === "Í≤∞ÏÑùÎ≥¥Í∞ï" ? "Í≤∞ÏÑùÎ≥¥Í∞ï" : "Ï∂îÍ∞ÄÏàòÏóÖ"}(${cls.class_name || "Î≥¥Í∞ï"})`,
      date: cls.makeup_date || cls.absence_date || "",
      backgroundColor: "#8b5cf6", // violet-500
      borderColor: "#8b5cf6",
      order: 4,
      extendedProps: {
        type: "makeup",
        data: cls,
      },
    })),
    // Consultations
    ...consultations.map((consult) => ({
      id: `consultation-${consult.id}`,
      title: `üí¨ ÏÉÅÎã¥`,
      date: consult.date,
      backgroundColor: "#ec4899", // pink-500
      borderColor: "#ec4899",
      order: 5,
      extendedProps: {
        type: "consultation",
        data: consult,
      },
    })),
  ]

  const handleEventClick = (info: any) => {
    setSelectedEvent({
      type: info.event.extendedProps.type,
      data: info.event.extendedProps.data,
    })
  }

  const renderEventDetail = () => {
    if (!selectedEvent) return null

    const { type, data } = selectedEvent

    if (type === "study") {
      const log = data as StudyLogItem
      return (
        <div className="space-y-3">
          <div>
            <span className="text-sm text-muted-foreground">Î∞ò:</span>
            <p className="font-semibold">{log.class_name || "-"}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">Ï∂úÏÑù:</span>
            <p className="font-semibold">
              {log.attendance_status ? attendanceLabels[log.attendance_status] : "-"}
            </p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">ÏàôÏ†ú:</span>
            <p className="font-semibold">{log.homework ? `${log.homework}Ï†ê` : "-"}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">ÏßëÏ§ëÎèÑ:</span>
            <p className="font-semibold">{log.focus ? `${log.focus}Ï†ê` : "-"}</p>
          </div>
          {log.note && (
            <div>
              <span className="text-sm text-muted-foreground">ÎπÑÍ≥†:</span>
              <p className="text-sm mt-1">{log.note}</p>
            </div>
          )}
        </div>
      )
    }

    if (type === "test") {
      const log = data as TestLogItem
      return (
        <div className="space-y-3">
          <div>
            <span className="text-sm text-muted-foreground">Î∞ò:</span>
            <p className="font-semibold">{log.class_name || "-"}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">Ïú†Ìòï:</span>
            <p className="font-semibold">{log.test_type || "-"}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">Ï†êÏàò:</span>
            <p className="font-semibold text-blue-600">
              {log.test_score !== null ? `${log.test_score}Ï†ê` : "-"}
            </p>
          </div>
          {log.note && (
            <div>
              <span className="text-sm text-muted-foreground">ÎπÑÍ≥†:</span>
              <p className="text-sm mt-1">{log.note}</p>
            </div>
          )}
        </div>
      )
    }

    if (type === "makeup") {
      const cls = data as MakeupClassItem
      return (
        <div className="space-y-3">
          <div>
            <span className="text-sm text-muted-foreground">Î∞ò:</span>
            <p className="font-semibold">{cls.class_name || "-"}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">Ïú†Ìòï:</span>
            <p className="font-semibold">{cls.makeup_type}</p>
          </div>
          {cls.makeup_type === "Í≤∞ÏÑùÎ≥¥Í∞ï" && (
            <>
              <div>
                <span className="text-sm text-muted-foreground">Í≤∞ÏÑùÏùº:</span>
                <p>{cls.absence_date || "-"}</p>
              </div>
              <div>
                <span className="text-sm text-muted-foreground">ÏÇ¨Ïú†:</span>
                <p>{cls.absence_reason || "-"}</p>
              </div>
            </>
          )}
          <div>
            <span className="text-sm text-muted-foreground">ÏÉÅÌÉú:</span>
            <p className="font-semibold">{cls.status}</p>
          </div>
          {cls.content && (
            <div>
              <span className="text-sm text-muted-foreground">ÎÇ¥Ïö©:</span>
              <p className="text-sm mt-1">{cls.content}</p>
            </div>
          )}
        </div>
      )
    }

    if (type === "consultation") {
      const consult = data as ConsultationItem
      return (
        <div className="space-y-3">
          <div>
            <span className="text-sm text-muted-foreground">Ïú†Ìòï:</span>
            <p className="font-semibold">{consult.type}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">Î∞©Î≤ï:</span>
            <p>{consult.method}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">ÏÉÅÎã¥Ïûê:</span>
            <p>{consult.counselor_name || "-"}</p>
          </div>
          {consult.content && (
            <div>
              <span className="text-sm text-muted-foreground">ÎÇ¥Ïö©:</span>
              <p className="text-sm mt-1 whitespace-pre-wrap">{consult.content}</p>
            </div>
          )}
        </div>
      )
    }

    if (type === "mathflat") {
      const record = data as MathflatRecordItem
      return (
        <div className="space-y-3">
          <div>
            <span className="text-sm text-muted-foreground">Ïú†Ìòï:</span>
            <p className="font-semibold">{record.mathflat_type || "-"}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">ÍµêÏû¨Î™Ö:</span>
            <p>{record.book_title || "-"}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">Ìëº Î¨∏Ï†úÏàò:</span>
            <p className="font-semibold text-pink-600">
              {record.problem_solved !== null ? `${record.problem_solved}Î¨∏Ï†ú` : "-"}
            </p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">Ï†ïÎãµÎ•†:</span>
            <p className="font-semibold text-pink-600">
              {record.correct_rate !== null ? `${record.correct_rate.toFixed(1)}%` : "-"}
            </p>
          </div>
          <div className="grid grid-cols-2 gap-2 pt-2 border-t">
            <div>
              <span className="text-xs text-muted-foreground">Ï†ïÎãµ:</span>
              <p className="text-sm font-semibold text-blue-600">{record.correct_count || 0}Í∞ú</p>
            </div>
            <div>
              <span className="text-xs text-muted-foreground">Ïò§Îãµ:</span>
              <p className="text-sm font-semibold text-red-600">{record.wrong_count || 0}Í∞ú</p>
            </div>
          </div>
        </div>
      )
    }

    return null
  }

  return (
    <>
      <Card>
        <CardHeader>
          <CardTitle className="text-lg font-semibold">ÌïôÏäµ Ï∫òÎ¶∞Îçî</CardTitle>
        </CardHeader>
        <CardContent>
          {/* Color Legend */}
          <div className="flex flex-wrap gap-4 mb-4 pb-4 border-b">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded bg-[#10b981]"></div>
              <span className="text-sm text-gray-700">ÌïôÏäµÏùºÏßÄ</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded bg-[#3b82f6]"></div>
              <span className="text-sm text-gray-700">ÌÖåÏä§Ìä∏</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded bg-[#f59e0b]"></div>
              <span className="text-sm text-gray-700">Îß§Ïì∞ÌîåÎû´</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded bg-[#8b5cf6]"></div>
              <span className="text-sm text-gray-700">Î≥¥Í∞ïÏàòÏóÖ</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded bg-[#ec4899]"></div>
              <span className="text-sm text-gray-700">ÏÉÅÎã¥</span>
            </div>
          </div>

          <div className="portal-calendar">
            <FullCalendar
              plugins={[dayGridPlugin, interactionPlugin]}
              initialView="dayGridMonth"
              events={events}
              eventClick={handleEventClick}
              eventOrder="order"
              headerToolbar={{
                left: "prev,next today",
                center: "title",
                right: "",
              }}
              height="auto"
              locale="ko"
              buttonText={{
                today: "Ïò§Îäò",
              }}
              eventDisplay="block"
              eventTimeFormat={{
                hour: "2-digit",
                minute: "2-digit",
                meridiem: false,
              }}
            />
          </div>
        </CardContent>
      </Card>

      {/* Event Detail Dialog */}
      <Dialog open={!!selectedEvent} onOpenChange={() => setSelectedEvent(null)}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>
              {selectedEvent?.type === "study" && "ÌïôÏäµÏùºÏßÄ"}
              {selectedEvent?.type === "test" && "ÌÖåÏä§Ìä∏"}
              {selectedEvent?.type === "makeup" && "Î≥¥Í∞ïÏàòÏóÖ"}
              {selectedEvent?.type === "consultation" && "ÏÉÅÎã¥"}
              {selectedEvent?.type === "mathflat" && "Îß§Ïì∞ÌîåÎû´"}
            </DialogTitle>
          </DialogHeader>
          {renderEventDetail()}
        </DialogContent>
      </Dialog>

      {/* Minimal Calendar Styling */}
      <style jsx global>{`
        .portal-calendar .fc {
          font-family: inherit;
        }
        .portal-calendar .fc-toolbar-title {
          font-size: 1.25rem;
          font-weight: 600;
        }
        .portal-calendar .fc-button {
          background-color: hsl(var(--background)) !important;
          border: 1px solid hsl(var(--border)) !important;
          color: hsl(var(--foreground)) !important;
          font-size: 0.875rem !important;
          padding: 0.375rem 0.75rem !important;
          border-radius: 0.375rem !important;
        }
        .portal-calendar .fc-button:hover {
          background-color: hsl(var(--muted)) !important;
        }
        .portal-calendar .fc-button-active {
          background-color: hsl(var(--primary)) !important;
          color: hsl(var(--primary-foreground)) !important;
        }
        .portal-calendar .fc-event {
          cursor: pointer;
          font-size: 0.75rem;
          padding: 2px 4px;
        }
        .portal-calendar .fc-daygrid-day-number {
          padding: 4px;
          font-size: 0.875rem;
        }
      `}</style>
    </>
  )
}
